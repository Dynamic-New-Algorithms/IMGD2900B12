### oppen to puplic use
    Dynamic New Algorithms
    William Decker
    Peter Lepper
###
class light
  constructor: (bg_img)->
    @x = 16
    @y = 16
    @r = 1
    @w = bg_img.width
    @h = bg_img.height
    cd = []
    pi = 0
    for yi in [0..(bg_img.height-1)]
      row = []
      for xi in [0..(bg_img.width-1)]
        row.push({r:bg_img.data[pi],g:bg_img.data[pi+1],b:bg_img.data[pi+2]})
        pi += 3
      cd.push(row)

    @core = []
    for xi in [0..(bg_img.width-1)]
      col = []
      for yi in [0..(bg_img.height-1)]
        col.push(cd[yi][xi])
        pi += 3
      @core.push(col)

    @changed = true

  draw: () ->
    if @changed
      img =  {width: @w,height: @h,pixelSize: 3, data: []}
      for yi in [0..@h-1]
        for xi in [0..@w-1]
          d = Math.sqrt(Math.pow((xi-@x),2)+Math.pow((yi-@y),2))
          a = 0
          a = 1-1/(d/@r) if (d/@r) >= 1
          img.data.push(Math.floor(@core[xi][yi].r * (1-a) + 0 * a))
          img.data.push(Math.floor(@core[xi][yi].g * (1-a) + 0 * a))
          img.data.push(Math.floor(@core[xi][yi].b * (1-a) + 0 * a))
      PS.ImageBlit(img)
      @changed = false


debug = (response) ->
  property_names = ""
  for propertyName of response
    ### propertyName is what you want###
    property_names += propertyName + " = " + response[propertyName] + "\n"
  alert property_names
###------------------------------------------ Global Vars ----------------------------------------- ###

G =
  GRID:
    WIDTH: 32
    HEIGHT: 32
IMG =
  test_room: {width: 32,height: 32, pixelSize: 3, data: [84,71,62,78,65,56,55,45,36,76,66,57,52,42,33,89,79,70,48,35,26,85,72,63,84,68,55,82,68,57,83,69,58,81,68,59,82,69,60,83,70,61,82,69,60,83,70,61,73,63,53,87,74,65,85,71,62,81,67,58,80,66,57,87,74,65,82,72,62,78,68,58,79,69,60,53,43,34,85,76,69,51,44,38,74,67,61,56,47,40,78,68,59,79,69,60,79,66,57,81,71,62,54,44,35,80,71,64,53,44,37,78,68,59,51,41,32,84,71,62,82,69,60,84,71,62,80,70,61,81,71,62,82,72,63,80,70,61,83,70,61,82,69,60,88,78,68,81,68,59,76,63,54,83,69,60,85,71,62,74,61,52,78,68,58,85,75,65,81,71,62,50,40,31,55,46,39,47,40,34,78,71,65,54,45,38,81,71,62,79,69,60,66,56,47,80,70,61,50,41,34,79,72,66,51,44,38,63,54,47,54,44,35,79,69,60,63,56,50,60,53,47,56,51,47,57,52,48,57,50,44,64,55,48,78,68,59,83,70,61,76,66,56,85,75,65,89,76,67,77,64,55,86,73,64,88,75,66,77,64,55,81,71,61,79,69,60,57,47,38,62,53,46,58,51,45,78,71,65,46,37,30,62,52,43,63,53,44,63,53,44,74,65,58,49,42,36,79,72,66,52,45,39,59,52,46,55,46,39,80,70,61,53,49,46,9,5,2,1,0,0,1,0,0,11,7,4,56,49,43,81,71,62,82,69,60,77,67,58,83,73,64,69,59,50,84,71,63,85,72,63,76,63,54,86,73,64,81,68,59,78,68,59,55,45,36,75,66,59,46,39,33,64,57,51,50,41,34,66,56,47,80,70,61,64,54,45,66,57,50,49,42,36,75,68,62,48,41,35,61,54,48,49,40,33,77,67,58,61,57,54,1,0,0,2,2,2,0,0,0,1,0,0,57,52,48,83,73,64,81,68,59,85,74,68,73,63,54,86,76,67,88,78,69,70,60,51,87,74,65,83,70,61,77,64,55,79,69,60,53,43,34,81,72,65,52,45,39,79,72,66,57,48,41,67,57,48,64,54,45,80,70,61,73,63,54,59,50,43,83,76,70,53,46,40,76,67,60,55,45,36,84,74,65,60,55,51,3,0,0,10,9,7,4,4,4,1,0,0,56,51,47,82,72,63,82,68,57,141,132,125,75,66,59,80,71,64,69,60,51,143,133,124,82,72,62,82,69,60,88,74,65,79,69,60,49,39,30,63,54,47,47,40,34,79,72,66,51,42,35,88,78,69,79,69,60,79,66,57,69,59,50,50,40,31,79,70,63,45,36,29,73,63,54,48,38,29,78,65,56,59,50,43,6,0,0,3,0,0,1,0,0,7,3,0,58,51,45,85,72,63,83,69,58,79,70,65,143,134,129,78,69,62,140,133,125,139,130,121,82,72,62,79,66,57,79,65,56,79,69,60,55,45,36,74,65,58,59,52,46,73,66,60,46,37,30,78,68,59,63,53,44,84,71,62,78,65,56,51,41,32,87,77,68,51,41,32,77,67,58,58,45,36,84,71,62,65,55,46,59,50,43,61,56,52,61,57,54,53,49,46,63,56,50,81,68,59,85,69,56,78,69,64,139,130,125,78,71,63,138,131,123,74,65,56,84,74,64,83,69,60,83,69,60,82,72,63,53,43,34,80,71,64,51,44,38,58,51,45,59,50,43,77,67,58,63,53,44,80,70,61,87,77,68,50,41,34,58,49,42,51,42,35,80,71,64,55,45,36,75,65,56,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,86,72,61,132,122,112,87,78,71,130,123,117,78,71,65,81,72,65,80,70,60,82,68,57,79,69,60,56,46,37,78,69,62,55,48,42,58,51,45,56,47,40,54,44,35,65,55,46,60,50,41,75,65,56,50,41,34,64,55,48,53,44,37,78,69,62,56,46,37,82,72,63,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,79,65,54,88,75,66,77,68,61,80,73,67,140,133,127,73,64,57,90,77,68,82,68,57,79,69,60,51,41,32,78,69,62,50,43,37,55,48,42,53,44,37,68,58,49,77,67,58,65,55,46,80,70,61,56,47,40,73,64,57,54,45,38,74,65,58,50,40,31,78,68,59,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,80,68,56,87,74,65,75,66,57,138,131,123,87,80,72,76,67,58,73,60,51,83,71,59,82,72,63,51,41,32,82,73,66,51,44,38,61,54,48,51,42,35,74,64,55,83,73,64,76,66,57,82,72,63,52,43,36,74,65,58,55,46,39,79,70,63,54,44,35,81,71,62,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,80,68,56,78,65,56,86,76,67,73,64,55,129,120,111,81,71,62,90,77,68,86,74,62,81,71,62,53,43,34,77,68,61,54,47,41,73,66,60,52,43,36,65,55,46,79,69,60,80,70,61,81,71,62,48,39,32,73,64,57,51,42,35,79,70,63,54,44,35,81,71,62,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,84,71,62,83,70,61,84,74,64,83,73,64,84,74,65,80,70,60,85,72,63,76,63,54,77,67,58,53,43,34,64,55,48,50,43,37,80,73,67,55,46,39,57,47,38,80,70,61,77,67,58,81,71,62,52,43,36,77,68,61,49,40,33,77,68,61,53,43,34,78,68,59,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,81,68,59,78,65,56,80,67,58,81,68,59,81,68,59,81,68,59,85,72,63,80,67,58,80,70,61,58,48,39,61,52,45,46,39,33,80,73,67,56,47,40,58,48,39,82,72,63,68,58,49,76,66,57,51,42,35,80,71,64,51,42,35,82,73,66,56,46,37,79,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,80,67,58,86,73,64,81,68,59,84,72,60,82,70,58,79,66,57,80,67,58,86,73,64,77,67,58,58,48,39,73,64,57,50,43,37,78,71,65,54,45,38,67,57,48,75,65,56,76,66,57,82,72,63,52,43,36,81,72,65,49,40,33,80,71,64,48,38,29,64,54,45,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,84,71,62,81,68,59,79,67,55,82,70,58,81,69,57,79,67,55,88,75,66,78,65,56,64,54,45,49,39,30,82,73,66,54,47,41,77,70,64,51,42,35,75,65,56,65,55,46,83,73,64,71,62,53,57,49,38,73,65,52,49,41,30,77,70,60,54,47,39,58,51,43,82,67,60,84,69,62,84,69,62,82,67,60,82,67,60,83,68,61,83,68,61,81,66,59,86,67,60,88,69,62,85,68,60,82,65,58,83,68,63,87,72,67,79,65,62,67,53,50,61,54,48,48,41,35,80,73,67,53,44,39,59,50,43,58,49,42,76,67,60,78,67,61,82,72,63,60,51,42,51,43,32,87,79,68,57,49,38,79,72,62,47,40,32,62,55,49,65,56,41,74,65,50,81,72,57,82,73,58,80,71,56,79,70,55,81,72,57,81,72,57,81,68,52,84,70,57,84,72,58,82,70,58,82,72,60,80,72,61,72,64,53,61,53,42,62,55,49,51,44,38,72,65,59,52,43,38,66,57,50,41,32,25,66,57,50,66,55,49,77,66,60,62,53,46,50,41,32,70,61,52,51,42,35,78,71,63,55,48,42,60,53,47,58,51,41,67,60,50,76,69,59,79,72,62,77,70,60,77,70,60,77,70,60,78,71,61,76,68,57,77,69,58,79,70,61,78,71,61,78,71,63,72,68,59,65,60,54,59,54,48,59,52,46,56,49,43,88,81,75,52,43,38,59,50,43,52,43,36,58,49,42,78,67,61,59,48,42,81,72,65,59,50,43,82,73,66,53,44,39,69,62,56,29,21,18,16,8,5,19,10,13,19,10,13,21,12,15,22,13,16,24,15,18,25,16,19,23,14,17,22,13,16,25,15,16,23,13,14,23,13,14,23,14,17,23,14,17,21,12,15,17,11,15,17,11,15,17,10,4,22,15,9,71,64,58,48,39,34,80,71,64,60,51,44,60,51,44,79,68,62,62,51,45,76,67,60,50,41,36,54,45,40,53,44,39,31,23,20,45,37,34,56,48,45,56,44,44,53,41,41,51,39,39,51,39,39,51,39,39,52,40,40,51,39,39,51,39,39,54,43,41,52,40,40,52,40,40,53,41,41,52,42,41,51,41,40,52,42,41,55,45,46,53,46,40,52,45,39,22,15,9,57,48,43,76,67,60,51,42,35,56,47,40,80,69,63,65,55,46,80,71,64,58,49,44,58,49,44,53,43,41,19,11,8,57,50,44,79,72,66,78,68,56,79,69,57,81,71,59,80,70,58,77,67,55,75,65,53,77,67,55,81,71,59,82,70,56,82,70,56,83,71,57,82,73,58,81,72,57,80,71,56,81,72,57,82,72,60,63,56,50,63,56,50,20,13,7,53,44,39,71,62,55,59,50,43,60,51,44,80,69,63,58,48,39,83,74,65,47,38,31,83,74,69,25,16,11,57,50,44,59,52,46,80,73,65,73,63,51,75,65,53,78,68,56,79,69,57,78,68,56,75,65,53,76,66,54,80,70,58,78,69,54,79,70,55,80,71,56,79,70,55,79,70,55,79,70,55,79,70,55,78,69,54,81,74,68,68,61,55,68,61,55,22,13,8,77,68,61,53,44,37,79,70,63,81,70,64,82,72,62,76,67,58,53,44,37,76,67,62,20,11,6,55,48,42,51,44,36,49,42,34,52,44,42,49,41,39,48,40,38,51,43,41,54,46,44,53,45,43,52,44,42,52,44,42,52,44,41,53,45,42,52,44,41,50,42,39,50,42,39,53,43,41,54,44,42,52,42,40,50,43,37,55,48,42,48,41,35,25,16,11,77,68,61,54,45,38,77,68,61,64,53,47,81,71,62,62,53,46,46,41,35,20,16,13,57,52,49,58,50,47,83,72,66,82,69,61,80,70,61,79,69,60,83,73,64,78,68,59,83,73,64,78,68,59,81,71,62,79,69,60,66,53,44,78,65,56,85,72,63,82,69,60,80,67,58,82,69,60,84,71,62,82,69,60,85,71,58,79,66,57,60,51,44,59,54,50,16,12,9,50,45,42,62,54,51,60,51,46,61,51,42,58,49,42,56,49,43,21,16,12,56,51,48,60,52,49,84,73,67,81,68,60,79,69,60,61,51,42,64,54,45,76,66,57,81,71,62,62,52,43,65,55,46,79,69,60,77,67,58,82,72,63,83,73,64,81,71,62,79,69,60,80,70,61,80,70,61,78,68,59,77,63,52,92,82,72,74,65,58,59,54,50,23,18,15,44,39,36,64,56,53,77,68,63,79,69,60,82,73,66,17,10,4,55,50,46,51,43,40,50,41,36,50,39,33,55,42,34,55,45,36,52,42,33,54,44,35,52,42,33,55,45,36,51,41,32,53,43,34,52,42,33,55,45,36,52,42,33,50,40,31,51,41,32,54,44,35,56,46,37,56,46,37,54,44,35,59,46,37,41,31,22,48,41,35,55,50,46,48,43,39,24,16,13,65,56,51,75,64,58,80,71,64,84,75,68,21,14,8,56,49,43,82,75,69,83,74,67,81,71,62,85,72,64,83,73,64,79,69,60,80,70,61,81,71,62,83,73,64,79,69,60,79,69,60,80,70,61,72,63,56,66,57,50,63,54,47,67,58,51,73,64,57,75,66,59,76,67,60,77,68,61,82,72,63,82,73,66,69,62,56,74,67,61,60,53,47,21,12,7,78,67,61,88,75,67,74,65,58,25,16,9,61,52,47,87,78,73,54,45,38,77,66,60,82,72,63,78,65,57,78,68,59,78,68,59,78,68,59,81,71,62,80,70,61,80,70,61,80,70,61,82,72,63,83,74,67,77,68,61,75,66,59,78,69,62,81,72,65,81,72,65,81,72,65,83,74,67,83,73,64,74,65,58,75,66,59,75,66,61,66,57,52,80,71,64,23,12,6,81,70,64,88,79,74,24,15,10,46,37,30,45,36,29,58,47,41,53,43,34,53,43,34,56,43,34,53,43,34,58,48,39,56,46,37,54,44,35,49,39,30,53,43,34,52,42,33,53,43,34,55,45,36,52,42,33,51,41,32,53,43,34,53,43,34,51,41,32,51,41,32,52,42,33,52,42,33,59,49,40,49,39,30,66,55,49,47,38,31,48,39,32,26,15,9,76,65,59,18,9,4,56,47,42,66,55,49,86,75,69,73,63,54,84,74,65,82,72,62,78,68,58,83,73,64,75,65,56,71,61,52,80,70,61,70,60,51,63,53,44,63,53,44,79,69,60,81,71,62,81,71,62,81,71,62,82,72,63,82,72,63,81,71,62,81,71,62,81,71,62,79,66,57,82,69,60,84,71,62,77,67,58,73,62,56,64,55,50,65,56,51,25,15,13,24,15,10,66,57,52,79,68,62,76,66,57,84,74,65,77,67,57,77,67,57,83,73,63,77,67,58,88,78,69,83,73,64,75,65,56,64,54,45,77,67,58,80,70,61,82,72,63,82,69,60,82,69,60,82,69,60,82,69,60,82,69,60,83,70,61,82,69,60,80,67,58,83,71,59,87,75,63,78,65,56,80,67,59,86,75,69,64,55,50,72,64,61,22,14,11]}


l = new light(IMG.test_room)
###------------------------------------------ PS Events ----------------------------------------- ###
PS.Init = ->
  PS.GridSize G.GRID.WIDTH, G.GRID.HEIGHT
  PS.BeadFlash PS.ALL,PS.ALL,false
  PS.BeadColor PS.ALL,PS.ALL,0x000000
  PS.BeadBorderWidth PS.ALL,PS.ALL,0
  PS.BeadBorderColor PS.ALL,PS.ALL,0x000000
  PS.GridBGColor 0x0000
  PS.StatusFade false
  PS.StatusText 'Stuck in the Void: toy 4'
  PS.StatusColor(0xffffff)



  PS.Clock 1

PS.Click = (x, y, data) ->
  "use strict"
  ###
  PS.ImageLoad "/assets/example_room_2.jpg", () ->
    data = PS.ImageData(this)
    debug data
    alert data.data.length
    PS.DebugOpen()
    PS.Debug(String(data.data))
    PS.ImageBlit(data)
  ###

PS.Release = (x, y, data) ->
  "use strict"

PS.Enter = (x, y, data) ->
  "use strict"
  if l.changed == false
    l.x = x
    l.y = y
    l.changed = true

PS.Leave = (x, y, data) ->
  "use strict"

PS.KeyDown = (key, shift, ctrl) ->
  "use strict"

PS.KeyUp = (key, shift, ctrl) ->
  "use strict"

PS.Wheel = (dir) ->
  "use strict"
  l.r += dir * 0.1
  l.r = Math.max(l.r,0.1)
  l.changed = true

PS.Tick = ->
  "use strict"
  l.draw()



### END OF GAME CODE ###